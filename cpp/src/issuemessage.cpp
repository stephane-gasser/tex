#include "issuemessage.h"
#include "noeud.h"
#include "impression.h"
#include "erreur.h"
#include "erreur.h"
#include "equivalent.h"
#include "lecture.h"
#include "getnext.h"
#include <iostream>

static bool longhelpseen = false;

void issuemessage(char status, Token t)
{
	scanNonMacroToksExpand(status, t);
	auto s = tokenshow(&defRef);
	defRef.list.clear();
	if (t.chr == 0)
	{
		print((termoffset+s.size() > maxprintline-2 ? "\n": termoffset > 0 || fileoffset > 0 ? " " : "")+s);
		std::cout << std::flush;
	}
	else
	{
		if (err_help())
		{
			error(s, "");
			useerrhelp = true;
		}
		else 
			if (longhelpseen)
				error(s, "(That was another \\errmessage.)");
			else
			{
				error(s, "This error message was generated by an \\errmessage\ncommand, so I can't give any explicit help.\nPretend that you're Hercule Poirot: Examine all clues,\nand deduce the truth by order and method.");
				if (interaction < error_stop_mode)
					longhelpseen = true;
			}
		useerrhelp = false;
	}
}
