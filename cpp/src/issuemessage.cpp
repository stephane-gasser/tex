#include "issuemessage.h"
#include "flushlist.h"
#include "impression.h"
#include "erreur.h"
#include "scantoks.h"
#include "makestring.h"
#include <iostream>
#include "texte.h"

static void erreurIssuemessage1(const std::string &s)
{
	print_err(s);
	error();
}

static void erreurIssuemessage2(const std::string &s)
{
	print_err(s);
	helpptr = 1;
	helpline[0] = "(That was another \\errmessage.)";
	error();
}

static void erreurIssuemessage3(const std::string &s)
{
	print_err(s);
	helpptr = 4;
	helpline[3] = "This error message was generated by an \\errmessage";
	helpline[2] = "command, so I can't give any explicit help.";
	helpline[1] = "Pretend that you're Hercule Poirot: Examine all clues,";
	helpline[0] = "and deduce the truth by order and method.";
	error();
}

void issuemessage(void)
{
	auto c = curchr;
	link(garbage) = scantoks(false, true);
	auto oldsetting = selector;
	selector = new_string;
	print(tokenshow(defref));
	selector = oldsetting;
	flushlist(defref);
	str_room(1);
	auto s = makestring(); 
	if (c == 0)
	{
		print((termoffset+s.size() > maxprintline-2 ? "\n": termoffset > 0 || fileoffset > 0 ? " " : "")+s);
		std::cout << std::flush;
	}
	else
	{
		if (err_help())
		{
			erreurIssuemessage1(s);
			useerrhelp = true;
		}
		else 
			if (longhelpseen)
				erreurIssuemessage2(s);
			else
			{
				erreurIssuemessage3(s);
				if (interaction < error_stop_mode)
					longhelpseen = true;
			}
		useerrhelp = false;
	}
	flush_string();
}
